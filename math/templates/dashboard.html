<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iSpace Math - Dashboard</title>
    
    <!-- Google Fonts - Orbitron for futuristic vibe -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
            <!-- Custom CSS and JS -->
        <link rel="stylesheet" href="styles.css">
        <script src="script.js" defer></script>
</head>
<body>
    <!-- Header with glowing space-themed gradient background -->
    <header class="header">
        <div class="header-content">
            <h1 class="app-title">iSpace Math</h1>
            <nav class="navigation">
                <ul class="nav-links">
                                    <li><a href="/home" class="nav-link">Home</a></li>
                <li><a href="/dashboard" class="nav-link">Dashboard</a></li>
                <li><a href="/" class="nav-link" id="logout-link">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main content area -->
    <main class="main-content">
        <div id="content">
            <!-- Greeting Section -->
            <section class="greeting-section space-card">
                <h2 class="greeting-title cosmic-text" id="greeting-title">Welcome, Explorer!</h2>
                <div class="user-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total XP:</span>
                        <span class="stat-value" id="total-xp">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Quizzes Completed:</span>
                        <span class="stat-value" id="quizzes-completed">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Average Score:</span>
                        <span class="stat-value" id="average-score">0%</span>
                    </div>
                </div>
            </section>

            <!-- Charts Section -->
            <section class="charts-section">
                <div class="charts-grid">
                    <!-- Accuracy Chart -->
                    <div class="chart-container space-card">
                        <h3 class="chart-title">Accuracy per Topic</h3>
                        <canvas id="accuracyChart"></canvas>
                    </div>

                    <!-- Time Chart -->
                    <div class="chart-container space-card">
                        <h3 class="chart-title">Average Time per Topic</h3>
                        <canvas id="timeChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Leaderboard Section -->
            <section class="leaderboard-section dashboard-container">
                <h3 class="dashboard-title">Top Performers</h3>
                <div class="leaderboard-tabs">
                    <button class="tab-button active" data-topic="all">All Topics</button>
                    <button class="tab-button" data-topic="algebra">Algebra</button>
                    <button class="tab-button" data-topic="geometry">Geometry</button>
                    <button class="tab-button" data-topic="trigonometry">Trigonometry</button>
                    <button class="tab-button" data-topic="calculus">Calculus</button>
                    <button class="tab-button" data-topic="statistics">Statistics</button>
                </div>
                
                <div class="leaderboard-content">
                    <table class="leaderboard-table" id="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Username</th>
                                <th>Topic</th>
                                <th>Level</th>
                                <th>Score</th>
                                <th>XP</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <!-- Leaderboard data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Recent Activity -->
            <section class="activity-section dashboard-container">
                <h3 class="dashboard-title">Recent Activity</h3>
                <div class="activity-list" id="activity-list">
                    <!-- Activity items will be populated here -->
                </div>
            </section>
        </div>
    </main>

    <!-- Footer with copyright -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2024 iSpace Math. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Dashboard functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Handle logout functionality
            const logoutLink = document.getElementById('logout-link');
            if (logoutLink) {
                logoutLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Clear all localStorage data
                    localStorage.removeItem('ispace_username');
                    localStorage.removeItem('ispace_auth_token');
                    localStorage.removeItem('ispace_sheet_url');
                    // Redirect to login page with logout parameter
                    window.location.href = '/?logout=true';
                });
            }

            // Check if user is logged in with valid session
            const storedUsername = localStorage.getItem('ispace_username');
            const authToken = localStorage.getItem('ispace_auth_token');
            
            if (storedUsername && authToken) {
                // Check if token is still valid (less than 24 hours old)
                const tokenTime = parseInt(authToken.replace('user_', ''));
                const currentTime = Date.now();
                const timeDiff = currentTime - tokenTime;
                const oneDay = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
                
                if (timeDiff >= oneDay) {
                    // Token is expired, clear it and redirect to login
                    localStorage.removeItem('ispace_username');
                    localStorage.removeItem('ispace_auth_token');
                    localStorage.removeItem('ispace_sheet_url');
                    window.location.href = '/';
                    return;
                }
            } else {
                // User is not logged in, redirect to login page
                window.location.href = '/';
                return;
            }

            const username = storedUsername || 'Anonymous';
            const results = JSON.parse(localStorage.getItem('ispace_results') || '[]');
            const totalXP = parseInt(localStorage.getItem('ispace_total_xp') || '0');
            
            // Update greeting
            document.getElementById('greeting-title').textContent = `Welcome, ${username}!`;
            
            // Update stats
            document.getElementById('total-xp').textContent = totalXP;
            document.getElementById('quizzes-completed').textContent = results.length;
            
            const averageScore = results.length > 0 
                ? Math.round(results.reduce((sum, result) => sum + result.score, 0) / results.length)
                : 0;
            document.getElementById('average-score').textContent = averageScore + '%';
            
            // Prepare data for charts
            const topics = ['algebra', 'geometry', 'trigonometry', 'calculus', 'statistics'];
            const topicLabels = ['Algebra', 'Geometry', 'Trigonometry', 'Calculus', 'Statistics'];
            
            // Calculate accuracy per topic
            const accuracyData = topics.map(topic => {
                const topicResults = results.filter(r => r.topic === topic);
                if (topicResults.length === 0) return 0;
                return Math.round(topicResults.reduce((sum, r) => sum + r.score, 0) / topicResults.length);
            });
            
            // Calculate average time per topic (simulated data)
            const timeData = topics.map(topic => {
                const topicResults = results.filter(r => r.topic === topic);
                if (topicResults.length === 0) return 0;
                // Simulate time data (in minutes)
                return Math.round((Math.random() * 3 + 1) * 10) / 10;
            });
            
            // Create accuracy chart
            const accuracyCtx = document.getElementById('accuracyChart').getContext('2d');
            new Chart(accuracyCtx, {
                type: 'bar',
                data: {
                    labels: topicLabels,
                    datasets: [{
                        label: 'Accuracy (%)',
                        data: accuracyData,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',   // Light Red for Algebra
                            'rgba(255, 205, 86, 0.8)',   // Light Yellow for Geometry
                            'rgba(75, 192, 192, 0.8)',   // Light Green for Trigonometry
                            'rgba(255, 159, 64, 0.8)',   // Light Orange for Calculus
                            'rgba(153, 102, 255, 0.8)'   // Light Purple for Statistics
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',     // Red border
                            'rgba(255, 205, 86, 1)',     // Yellow border
                            'rgba(75, 192, 192, 1)',     // Green border
                            'rgba(255, 159, 64, 1)',     // Orange border
                            'rgba(153, 102, 255, 1)'     // Purple border
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(25, 55, 109, 0.2)'
                            },
                            ticks: {
                                color: '#ffffff'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(25, 55, 109, 0.2)'
                            },
                            ticks: {
                                color: '#ffffff'
                            }
                        }
                    }
                }
            });
            
            // Create time chart
            const timeCtx = document.getElementById('timeChart').getContext('2d');
            new Chart(timeCtx, {
                type: 'line',
                data: {
                    labels: topicLabels,
                    datasets: [{
                        label: 'Average Time (minutes)',
                        data: timeData,
                        borderColor: 'rgba(75, 192, 192, 1)',  // Light Green
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(25, 55, 109, 0.2)'
                            },
                            ticks: {
                                color: '#ffffff'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(25, 55, 109, 0.2)'
                            },
                            ticks: {
                                color: '#ffffff'
                            }
                        }
                    }
                }
            });
            
            // Populate leaderboard
            function populateLeaderboard(topic = 'all') {
                const leaderboardBody = document.getElementById('leaderboard-body');
                leaderboardBody.innerHTML = '';
                
                let filteredResults = results;
                if (topic !== 'all') {
                    filteredResults = results.filter(r => r.topic === topic);
                }
                
                // Sort by XP (descending)
                filteredResults.sort((a, b) => b.xp - a.xp);
                
                // Take top 10
                const topResults = filteredResults.slice(0, 10);
                
                topResults.forEach((result, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${result.username}</td>
                        <td>${result.topic.charAt(0).toUpperCase() + result.topic.slice(1)}</td>
                        <td>${result.level.charAt(0).toUpperCase() + result.level.slice(1)}</td>
                        <td>${result.score}%</td>
                        <td>${result.xp} XP</td>
                    `;
                    leaderboardBody.appendChild(row);
                });
                
                if (topResults.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="6" style="text-align: center;">No data available</td>';
                    leaderboardBody.appendChild(row);
                }
            }
            
            // Initialize leaderboard
            populateLeaderboard();
            
            // Tab functionality
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    // Populate leaderboard for selected topic
                    const topic = this.getAttribute('data-topic');
                    populateLeaderboard(topic);
                });
            });
            
            // Populate recent activity
            function populateActivity() {
                const activityList = document.getElementById('activity-list');
                activityList.innerHTML = '';
                
                // Get recent results (last 5)
                const recentResults = results.slice(-5).reverse();
                
                recentResults.forEach(result => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item space-card';
                    activityItem.innerHTML = `
                        <div class="activity-icon">📊</div>
                        <div class="activity-content">
                            <div class="activity-title">${result.username} completed ${result.topic} (${result.level})</div>
                            <div class="activity-details">Score: ${result.score}% | XP: ${result.xp}</div>
                            <div class="activity-time">${new Date(result.timestamp).toLocaleDateString()}</div>
                        </div>
                    `;
                    activityList.appendChild(activityItem);
                });
                
                if (recentResults.length === 0) {
                    const noActivity = document.createElement('div');
                    noActivity.className = 'no-activity';
                    noActivity.textContent = 'No recent activity';
                    activityList.appendChild(noActivity);
                }
            }
            
            populateActivity();
        });
    </script>
</body>
</html> 